---
title: "ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä¸­ã§send_dataã®å¾Œã«redirect_toã‚’å‘¼ã¶ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ç†ç”±"
emoji: "ğŸ¦§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['Rails', 'Ruby']
published: false
---

## send_dataã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ãŸå¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

(send_data)[https://railsdoc.com/page/send_data]ã—ãŸå¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹å‡¦ç†ã‚’æ›¸ã„ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”¨æ„ã—ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã—ã¾ã™ã€‚

```ruby
class SampleController < ApplicationController
  def hoge
    send_data('hoge', filename: 'hoge.txt')
    render html: "<h2>hello world</h2>".html_safe
  end
end
```

ãã®ä¸Šã§ãƒšãƒ¼ã‚¸ã«é·ç§»ã™ã‚‹ã¨`AbstractController::DoubleRenderError`ãŒå‡ºã¾ã™ã€‚
ã“ã‚Œã¯send_dataãƒ¡ã‚½ãƒƒãƒ‰ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ãƒ­ã‚¸ãƒƒã‚¯ã§ã‚ã‚‹ãŸã‚äºŒé‡ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã™è¿”ã™å‡¦ç†ã‚’æ›¸ã„ã¦ã—ã¾ã£ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

```txt
Render and/or redirect were called multiple times in this action. Please note that you may only call render OR redirect, and at most once per action. Also note that neither redirect nor render terminate execution of the action, so if you want to exit an action after redirecting, you need to do something like "redirect_to(...) and return".
```

ã“ã“ã§ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¦‹ã¦ã¿ã‚‹ã¨`Please note that you may only call render OR redirect, and at most once per action.`ã¨ã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…ã§`redirect_to`ãƒ¡ã‚½ãƒƒãƒ‰ã¯ä¸€åº¦ã—ã‹ä½¿ç”¨ã—ã¦ãŠã‚‰ãš`render`ãƒ¡ã‚½ãƒƒãƒ‰ã«è‡³ã£ã¦ã¯å‘¼ã°ã‚Œã¦ã„ã¾ã›ã‚“ã€‚èª¿æŸ»ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚


## èª¿æŸ»
### äºˆæƒ³
`send_data`ãŒå†…éƒ¨çš„ã«`render`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã€ã¨ã‹ã§ã‚ã‚Œã°2å›`render`ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã¦ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ã«è¾»è¤„ãŒåˆã„ãã†ã§ã™ã€‚

### binding.irbã§èª¿æŸ»
`bindng.irb`ã‚’æŒŸã‚“ã§èª¿æŸ»ã—ã¾ã™ã€‚

```ruby
class SampleController < ApplicationController
  def hello
    binding.irb
    send_data('hoge', filename: 'hoge.txt')
    render html: "<h2>hello world</h2>".html_safe
  end
end
```

`method(:send_data).source_location`ã§ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´æ‰€ã‚’ç‰¹å®šã™ã‚‹ã¨æ¬¡ã®ã‚³ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚

https://github.com/rails/rails/blob/f8e97a1464e0ab7feabf87f9da7fd9a86af509a0/actionpack/lib/action_controller/metal/instrumentation.rb#L34-L38

`super`ãŒå‘¼ã°ã‚Œã¦ã„ã‚‹ã®ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¾ãŸã¯ç¶™æ‰¿ã‚¯ãƒ©ã‚¹ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹åŒåã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¢ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãã“ã§binding.irbä¸­ã§ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```ruby
# bingig.irbã®ä¸­
self.class.ancestors.each do |m|
  i_methods = []
  # ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¾ãŸã¯ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ã—ã¦ã„ãªã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å–ã‚Šå‡ºã™
  i_methods << m.instance_methods(false)
  i_methods << m.private_instance_methods(false)

  # send_dataã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¾ãŸã¯ã‚¯ãƒ©ã‚¹
  puts m if i_methods.map(&:to_s).grep(/send_data/).present?
end
```

å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè©²å½“ã™ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
`ActionController::Instrumentation`ã¯æ—¢ã«è¦‹ã¦ã„ã‚‹ã®ã§`ActionController::DataStreaming`ã‚’èª¿ã¹ã¾ã™ã€‚
`ActionController::DataStreaming.instance_method(:send_data).source_location`ã§ãƒ¡ã‚½ãƒƒãƒ‰ã®å®šç¾©å ´æ‰€ã‚’ç‰¹å®šã—ã¾ã™ã€‚


ã‚„ã¯ã‚Šäºˆæƒ³é€šã‚Š`render`ãŒå‘¼ã°ã‚Œã¦ã„ã¾ã—ãŸã€‚ã‚ã§ãŸã—ã‚ã§ãŸã—ã€‚

https://github.com/rails/rails/blob/f8e97a1464e0ab7feabf87f9da7fd9a86af509a0/actionpack/lib/action_controller/metal/data_streaming.rb#L109-L112
