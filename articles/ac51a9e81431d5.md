---
title: "Railsã‚¬ã‚¤ãƒ‰ãƒ¡ãƒ¢"
emoji: "ğŸ¦§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['Rails']
published: false
---

## Active Record ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- é€†é€²ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹å ´åˆã¯`revert`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹
```ruby
require_relative '20220918062843_add_part_number_to_posts'

class FixupExampleMigration < ActiveRecord::Migration[7.0]
  def change
    revert AddPartNumberToPosts
  end
end
```

- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§`execute`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§[ãƒˆãƒªã‚¬ãƒ¼](https://docs.oracle.com/cd/E15817_01/server.111/e05765/triggers.htm)ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹SQLã®ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£æ©Ÿèƒ½ã‚’å°å…¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãŒã€Active Recordã®ã€Œé«˜åº¦ãªæ©Ÿèƒ½ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã¯ãªããƒ¢ãƒ‡ãƒ«ã«å­˜åœ¨ã™ã‚‹ã€ã¨ã„ã†ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«åã™ã‚‹ã®ã§ã‚ã¾ã‚Šä½¿ç”¨ã•ã‚Œãªã„

## Active Record ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- å±æ€§åã‚’å‹•çš„ã«å¤‰æ›´å¯èƒ½ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œã‚Šæ–¹

```ruby
class CamelValidator < ActiveModel::Validator
  def validate(record)
    field = options[:field]
    return if record.public_send(field) != record.public_send(field).upcase

    record.errors.add field, "å¤§æ–‡å­—ã§ã™"
  end
end
```

```ruby
class Fruit < ApplicationRecord
  validates_with CamelValidator, field: :name
end
```
- å³å¯†ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```ruby
class Person < ApplicationRecord
  validates :name, presence: { strict: true }
end
```
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒç„¡åŠ¹ã§ã‚ã‚‹ã¨ãã«`ActiveModel::StrictValidationFailed`ã‚’ç™ºç”Ÿã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
-> ç”Ÿç„¼ã‘ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ç™ºç”Ÿã‚’é˜²ãã“ã¨ãŒã§ããã†ã€‚

## Active Record ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
- é–¢é€£ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆé–“ã§update_atã‚’é€£å‹•ã•ã›ã‚‹æ–¹æ³•

```ruby
class Employee < ApplicationRecord
  belongs_to :company, touch: true
end

class Company < ApplicationRecord
  has_many :employees
end
```

`Employee`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒtouchã•ã‚Œã‚‹åº¦ã«é–¢é€£ã™ã‚‹`Company`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚‚touchã•ã‚Œã‚‹

- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ã‚¯ãƒ©ã‚¹åŒ–ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

https://railsguides.jp/active_record_callbacks.html#%E3%82%B3%E3%83%BC%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF%E3%82%AF%E3%83%A9%E3%82%B9

- after_saveã¨after_commitã®ä½¿ã„åˆ†ã‘
 - after_saveå†…ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒèµ°ã‚‹ã®ã§saveã¯ç„¡ã‹ã£ãŸã“ã¨ã«ãªã‚‹
 - after_commitã®å ´åˆã¯saveã¯ãªã‹ã£ãŸã“ã¨ã«ãªã‚‰ãªã„

ãƒ­ã‚°ä¿å­˜å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸçµæœsaveè‡ªä½“ãŒãªããªã‚‹ã“ã¨ã¯æœ›ã¾ã—ãã¯ãªã„ãŸã‚ã€after_commitã®æ–¹ãŒè‰¯ã•ãã†





