---
title: "Dockerã‚³ãƒ³ãƒ†ãƒŠã«sshæ¥ç¶šã™ã‚‹"
emoji: "ğŸ”‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Docker"]
published: false
---

## ã¯ã˜ã‚ã«
SSHæ¥ç¶šã®æ‰‹é †ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«SSHæ¥ç¶šå¯èƒ½ãªDockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã—ãŸã€‚
## æ‰‹é †
### ã‚³ãƒ³ãƒ†ãƒŠã®æº–å‚™
```dockerfile:dockerfile
FROM centos:centos7
 
RUN yum -y update \
 && yum install -y openssh-server \
    openssh-clients \
 && yum clean all
 
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³ã‚’è¨±å¯ã—ãªã„
# ãƒãƒ¼ãƒˆã‚’22ã‹ã‚‰20022ã«å¤‰æ›´
# rootã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’passwordã«è¨­å®š
RUN sed -ri 's/^#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config \
 && sed -ri 's/^#Port 22/Port 20022/' /etc/ssh/sshd_config \
 && echo 'root:password' | chpasswd
  
EXPOSE 20022
```

```yml:docker-compose.yml
version: "3"
services:
  server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: server
    privileged: true
    command: /sbin/init
    ports:
      - 20022:20022
```

### å…¬é–‹éµã®ä½œæˆ
ä»Šå›ã¯ç‰¹ã«æŒ‡å®šãªã—ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®rsaã‚¿ã‚¤ãƒ—ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```sh
$ ssh-keygen
```

é©å½“ã«åå‰ã‚’ä»˜ã‘ã¦ï¼ˆä»Šå›ã¯`docker_ssh_rsa`ï¼‰ä¿å­˜ã—ã¾ã™ã€‚
`docker_ssh_rsa.pub`ã¨ã„ã†å…¬é–‹éµãŒä½œæˆã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

### å…¬é–‹éµã®ç™»éŒ²

ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã•ã›ãŸä¸Šã§ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ³ãƒ†ãƒŠã«å…¬é–‹éµã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã™ã€‚

```sh
$ docker-compose up -d
$ docker compose cp <å…¬é–‹éµã®ãƒ‘ã‚¹>ã€€server:/root

# ä¾‹
$ docker compose cp ~/.ssh/docker_ssh_rsa.pub server:/root
```

æ¬¡ã«ã€ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã£ãŸä¸Šã§å…¬é–‹éµã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```sh
$ docker-compose exec server /bin/bash
```

```sh
# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œ
$ mkdir ~/.ssh
$ chmod 700 ~/.ssh
$ cat ~/docker_ssh_rsa.pub >> ~/.ssh/authorized_keys
$ chmod 644 ~/.ssh/authorized_keys
```

ä»¥ä¸Šã«ã‚ˆã‚Šã‚³ãƒ³ãƒ†ãƒŠã«å…¬é–‹éµã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

### æ¥ç¶šã—ã¦ã¿ã‚‹
ãƒ›ã‚¹ãƒˆã‹ã‚‰æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦æ¥ç¶šã—ã¦ã¿ã¾ã™ã€‚

```sh
$ ssh -i ~/.ssh/docker_ssh_rsa -p 20022 root@localhost
```

ã‚ã‚‹ã„ã¯ã€`~/.ssh/config`ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’ã—ã¦ã„ã‚‹å ´åˆ

```sh:~/.ssh/config
Host docker-ssh
  HostName localhost
  User root
  IdentityFile ~/.ssh/docker_ssh_rsa
  Port 20022
```

`ssh docker-ssh`ã§æ¥ç¶šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

## ã‚³ãƒ¼ãƒ‰
ä½¿ç”¨ã—ãŸdockerãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- https://github.com/akmhmgc/docker-ssh-sample

## å‚è€ƒ
- [æœ¬æ°—ã§å­¦ã¶ Linuxå®Ÿè·µå…¥é–€ ã‚µãƒ¼ãƒé‹ç”¨ã®ãŸã‚ã®æ¥­å‹™ãƒ¬ãƒ™ãƒ«ç®¡ç†è¡“](https://www.amazon.co.jp/%E6%9C%AC%E6%B0%97%E3%81%A7%E5%AD%A6%E3%81%B6-Linux%E5%AE%9F%E8%B7%B5%E5%85%A5%E9%96%80-%E3%82%B5%E3%83%BC%E3%83%90%E9%81%8B%E7%94%A8%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E6%A5%AD%E5%8B%99%E3%83%AC%E3%83%99%E3%83%AB%E7%AE%A1%E7%90%86%E8%A1%93-%E5%A4%A7%E7%AB%B9-%E9%BE%8D%E5%8F%B2/dp/4797397640)
