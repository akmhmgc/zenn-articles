---
title: "Railsのscopeは何をやっているか"
emoji: "📃"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ruby", "rails"]
published: false
---

## scopeはクラスメソッドと同じ！？
モデル内で以下のようなスコープを定義します。

```ruby
class Fruit < ApplicationRecord
  scope :red, -> { where(color: 'red') }
end
```
すると、`Fruit.red`で呼び出し可能になります。

```ruby
> Fruit.red
# Fruit Load (0.1ms)  SELECT "fruits".* FROM "fruits" WHERE "fruits"."color" = ?  [["color", "red"]]
```

一方で、以下のようなクラスメソッドを定義します。

```ruby
class Fruit < ApplicationRecord
  def self.red
    where(color: "red")
  end
end
```
すると同様に、`Fruit.red`で呼び出し可能で同様のSQL文が発行されていることがわかります。

```ruby
> Fruit.red
# Fruit Load (0.1ms)  SELECT "fruits".* FROM "fruits" WHERE "fruits"."color" = ?  [["color", "red"]]
```

これを見るとクラスメソッドとscopeが同じよう感じられたためソースコードを読んでみました。

## 結論：scopeは内部的にクラスメソッドを定義する＋他にも色々やっている
[Ruby用語集](https://docs.ruby-lang.org/ja/3.1/doc/glossary.html)によると、クラスメソッドとは「そのオブジェクトの特異クラスのインスタンスメソッド」と書かれています。
ここで、railsのスコープのソースコードを確認すると`singleton_class.define_method`という記述が存在します。

https://github.com/rails/rails/blob/d66441f39127c284c2fc7ac9bfe3e8270b115033/activerecord/lib/active_record/scoping/named.rb#L174-L178

これはまさに特異クラスでインスタンスメソッドを定義しています。つまりscopeを定義したクラスから見るとクラスメソッドが定義されたということに他なりません。

一方でscopeを使用すると単純にクラスメソッドを定義する方法では不可能な表現を行うことができます。

```ruby
class Fruit < ApplicationRecord
  scope :red, -> { where(color: 'red') } do
    def tag
      'red'
    end
  end
end
```

```ruby
> Fruit.red.tag
=> "red"
```

まとめると、クラスメソッドが定義されるのはscopeの一部の機能にすぎないというわけです。

## scopeのソースコードでやっていること



## 参考
- https://qiita.com/tatsu0209/items/5b91c4698d5631c74869#comment-8670528e1910cda57f4d

